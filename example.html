<!--
  Thank you for looking at this example source code!
  This is the interesting bit, the rendered version is just the user interface.

  Notice this file is self contained, no external dependencies.
  Just an HTML file with some Javascript that runs in the context of the window.
-->
<html>
    <head>
        <meta charset="UTF-8" />
        <script>
          const blockSize = 16 // bytes
          const keyLength = 256 // bits (= 32 bytes)

          // Turn an ASCII-encoded hexadecimal string into the corresponding byte array
          function hexStringToBytes(input) {
            for (var bytes = [], c = 0; c < input.length; c += 2) {
              bytes.push(parseInt(input.substr(c, 2), 16));
            }
            return Uint8Array.from(bytes);
          }

          // The cleartext input must be padded to a multiple of the block size
          // for encryption. This function removes the padding, expected to be
          // compatible with PKCS#7 described in RFC 5652.
          // https://en.wikipedia.org/wiki/Padding_(cryptography)#PKCS#5_and_PKCS#7
          function removePadding(input) {
            // Last byte is the amount of padding
            padAmount = input[input.length-1]
            unpaddedSize = input.length - padAmount
            return input.slice(0, unpaddedSize)
          }

          // Update page with status of decryption
          function setMessage(msg) {
            document.getElementById("errormsg").innerHTML = msg
          }

          async function decrypt() {

            try {
              setMessage("⏳ Decrypting...")

              // Read and validate Salt
              saltHex = document.getElementById("salt").value
              saltBytes = hexStringToBytes(saltHex)
              if (saltBytes.length != blockSize) {
                setMessage("❌ Invalid salt")
                return
              }

              // Read and validate IV
              ivHex = document.getElementById("iv").value
              ivBytes = hexStringToBytes(ivHex)
              if (ivBytes.length != blockSize) {
                setMessage("❌ Invalid IV")
                return
              }

              // Read and validate Password
              password = document.getElementById("password").value
              passwordBytes = new TextEncoder().encode(password)
              if (password.length == 0) {
                setMessage("❌ Missing password")
                return
              }

              // TODO rather than pulling these values from the HTML,
              // save as vars in JS and push them to the page on load.

              // Load ciphertext
              cipherHex = document.getElementById("cipher").value
              cipherBytes = hexStringToBytes(cipherHex)

              // Create a 'raw' key (W3C API object wrapping a password)
              passwordKey = await window.crypto.subtle.importKey(
                "raw",
                passwordBytes,
                {name: "PBKDF2"}, // Use this key as input to PBKDF2 key generator
                false, // not extractable
                ["deriveKey"]
              )

              // Create the key (by deriving it with PBKDF2 from the password)
              key = await window.crypto.subtle.deriveKey(
                {
                  name: "PBKDF2", // Key derivation algorithm
                  salt: saltBytes,
                  iterations: 1000000,
                  hash: "SHA-1", // As per standard v2.0
                },
                passwordKey,
                {
                  name: "AES-CBC", // Block cipher algorithm it's used for
                  length: keyLength,
                },
                false, // not extractable
                ["decrypt"] // This is a decryption key
              )

              // Use the key to decrypt the ciphertext
              // TODO: maybe switch to AES-GCM (built-in authentication, does it
              // buy anything in this context?
              decrypted = await window.crypto.subtle.decrypt(
                {
                  name: "AES-CBC",
                  iv: ivBytes,
                },
                key,
                cipherBytes
              )

              // Remove plaintext padding
              decryptedBytes = removePadding(new Uint8Array(decrypted))

              // Decode bytes to UTF-8
              output = new TextDecoder().decode(decryptedBytes)

              setMessage("✅ Decrypted successfully")

              // Display the plaintext on the page
              document.getElementById("plaintext").innerHTML = output
              // TODO: this way of inserting may inject HTML or JS.
              // Make the message inert, so hitting decrypt is always safe.

            } catch (err) {
              // TODO better handle failing promises
              setMessage("❌ Decryption failed (wrong password?)")
              return
            }
          }
        </script>
        <style>
          body {
            background-color: floralwhite;
            font-size: large;
          }

          div {
            margin: 5px;
          }

          p.plaintext {
            background-color: lavender;
            border: 2px dotted black;
            padding: 3px;
          }

          p.hint {
            background-color: lavender;
            border: 2px dashed black;
            padding: 3px;
          }
        </style>
    </head>
    <!--
      The rest of this is just the HTML fields displayed on the page.
      The only active element is the decrypt button.
    -->
    <body>
        <h1>Portable Secret: Example</h1>

        <p>This file is self-contained.
        It has no dependencies and runs entirely within the browser window.</p>
        <p>No internet connection is required. You can right-click, save it as HTML file, then open from disk with a browser of your choice.</p>
        <p>If I were you, I'd take a look at the source code before downloading and running any file.
          The code is short, simple and commented, and should only take a minute to grok.</p>

        <div>
          <h4>Password hint:</h4>
          <p class="hint">When creating a secret you can optionally include a password hint for yourself or the recipient of the secret.<br>
          In this case, no guessing: <strong>the password is banana</strong></p>
        </div>

        <div>
          <h4>Password:</h4>
          <input type="text" id="password" placeholder="See hint above" required>
        </div>

        <br>

        <div>
          <input type="button" value="🗝 Decrypt" onclick='decrypt()'>
          <span></span>
          <span id="errormsg"></span>
        </div>

        <div>
          <p id="plaintext" class="plaintext"></p>
        </div>

        <details>
            <summary>Show opaque inputs</summary>

            These are decryption inputs that can be safely transmitted in the clear.
            Without a password they are useless.

            <div>
              Salt:
              <input type="text" id="salt" value="f85b7c02fb93064f13dda0c26fcbb336" required>
            </div>

            <div>
              IV:
              <input type="text" id="iv" value="35ba805ef946e860ef036cb7b95433bf" required>
            </div>

            <div>
              Ciphertext:<br>
              <textarea rows="8" cols="80" id="cipher">29c089b7ebfd399b35d431e4a026dc9827ce6bdf8b975f1a9da204da022df95e8110fa3cb4080640f74b363a00f2f4ed70d6b78a4852cf2b46dc825bc1128dd0b6eb868c194c5e65fd6e9653fb9fda81cfd3e5bc378e3d5982dc39907564b0001754d4176f4186ab80842ddae1bc7c5bf454af8293129bb7da33d970eb014d2a77aead78544c683a0ff8dcfe363dad4c8a38e597acccd7b1f4e4928154ec4511e4eaba02fa0a3d1cece4095d7ad4db0e00e517af5aa582394f623d411a7daf05883ab8dd7b76165e68efae9797122979b53a7509ae281096bf7403ef7b46a539b63735c7f03d694492b8dc65c74431c41a37a1352c8b570d6135baa1034309e3c8748d5577662fc8628de90805809a37852b40bfa3697a0b884c920d8d2959430bd1a9504cc437fe74277608c905b3a0d5e9f2ce28bb0f56d351fa774dfcd81a352d41353db2db5217cb0a8bba2797ac0fc8be4c97c081312fa8b1fee29950cc3c53e2e26736ff0d6d0421259059872d7d6b03be86bedf31e2d9f252fd5a89746983ce180f26f629dca68901fd4dba972da193cd99fd6394f6c6976ea7ef151c2811754e6a0a8ff19c0d47bf8a0a6137dcb051c70db96cefc046323f8f9210be43134f1b5ecd039f0f754a0803269ad6c4899f37ea7f32f31cd2918220bbf6da</textarea>
            </div>
        </details>

    </body>
</html>
