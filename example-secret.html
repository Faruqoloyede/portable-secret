<!--
  Thank you for looking at this example source code!
  This is the interesting bit, the rendered version is just the user interface.

  Notice this file is self contained, no external dependencies.
  Just an HTML file with some Javascript that runs in the context of the window.
-->
<html>
    <head>
        <meta charset="UTF-8" />
        <script>
          const blockSize = 16

          // Turn an ASCII-encoded hexadecimal string into the corresponding byte array
          function hexStringToBytes(input) {
            for (var bytes = [], c = 0; c < input.length; c += 2) {
              bytes.push(parseInt(input.substr(c, 2), 16));
            }
            return Uint8Array.from(bytes);
          }

          // The cleartext input must be padded to a multiple of the block size
          // for encryption. This function removes the padding.
          // https://en.wikipedia.org/wiki/Padding_(cryptography)#PKCS#5_and_PKCS#7
          function removePadding(input) {
            padAmount = input[input.length-1]
            unpaddedSize = input.length - padAmount
            return input.slice(0, unpaddedSize)
          }

          function setMessage(msg) {
            document.getElementById("errormsg").innerHTML = msg
          }

          async function decrypt() {

            setMessage("⏳ Decrypting...")

            // Read and validate Salt
            saltHex = document.getElementById("salt").value
            saltBytes = hexStringToBytes(saltHex)
            if (saltBytes.length != blockSize) {
              setMessage("❌ Invalid salt")
              return
            }

            // Read and validate IV
            ivHex = document.getElementById("iv").value
            ivBytes = hexStringToBytes(ivHex)
            if (ivBytes.length != blockSize) {
              setMessage("❌ IV")
              return
            }

            // Read and validate Password
            password = document.getElementById("password").value
            passwordBytes = new TextEncoder().encode(password)
            if (password.length == 0) {
              setMessage("❌ Missing password")
              return
            }

            // Load ciphertext
            cipherHex = document.getElementById("cipher").value
            cipherBytes = hexStringToBytes(cipherHex)

            // Create a raw key (W3C API wrapper around a password)
            passwordKey = await window.crypto.subtle.importKey(
              "raw",
              passwordBytes,
              {name: "PBKDF2"}, // Use this key as input to PBKDF2 key generator
              false, // not extractable
              ["deriveKey", "deriveBits"]
            )

            // Create the key, by deriving it with PBKDF2 from the password
            key = await window.crypto.subtle.deriveKey(
              {
                name: "PBKDF2", // Key derivation algorithm
                salt: saltBytes,
                iterations: 1000000,
                hash: "SHA-1", // As per standard v2.0
              },
              passwordKey,
              {
                name: "AES-CBC", // Use this key to decrypt AES-CBC mode
                length: 256, // bits -> 32 bytes
              },
              false, // not extractable
              ["encrypt", "decrypt"]
            )

            // Use the key to decrypt the ciphertext
            decrypted = await window.crypto.subtle.decrypt(
              {
                name: "AES-CBC",
                iv: ivBytes,
              },
              key,
              cipherBytes
            )

            // Remove padding added before encryption
            decryptedBytes = removePadding(new Uint8Array(decrypted))

            // Decode bytes to UTF-8
            output = new TextDecoder().decode(decryptedBytes)

            setMessage("✅ Decrypted successfully")
            document.getElementById("plaintext").innerHTML = output
          }
        </script>
        <style>
          body {
            background-color: coral;
            font-size: large;
          }
          div {
            margin: 5px;
          }

        </style>
    </head>
    <body>
        <h1>Portable Secret: Example</h1>

        This file is self-contained. You can save and open it with a browser
        straight from your disk. It has no dependencies and runs entirely within the
        browser window. No internet connection required.

        <div id="other_inputs">
          <div>
            Salt:
            <input type="text" id="salt" value="f8d5694b6592c9cdcb7ab6c27c8f42dd" required>
          </div>

          <div>
            IV:
            <input type="text" id="iv" value="9d29a88414532f2e9465fde5d5b130a3" required>
          </div>
        </div>

        <div>
          Password hint:<br>
          When creating a secret you can optionally include a password hint for yourself or the recipient of the secret.
          In this case, no guessing: <strong>the password is banana</strong>.
        </div>

        <div>
          Password:<br>
          <input type="text" id="password" placeholder="See hint     👆👆👆" required>
        </div>

        <div>
          Ciphertext:<br>
          <textarea rows="8" cols="80" id="cipher">bb0f1d488345fcfcf24eed42004b12ca6d57610676a84a05c214965f5fc514d9</textarea>
        </div>

        <br>
        <br>

        <div>
          <input type="button" value="🗝 Decrypt" onclick='decrypt()'>
          <span id="errormsg"></span>
        </div>

        <div>
          <p id="plaintext"></p>
        </div>


    </body>
</html>
